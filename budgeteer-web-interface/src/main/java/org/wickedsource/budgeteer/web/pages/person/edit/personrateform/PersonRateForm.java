package org.wickedsource.budgeteer.web.pages.person.edit.personrateform;

import org.apache.wicket.AttributeModifier;
import org.apache.wicket.extensions.markup.html.form.select.IOptionRenderer;
import org.apache.wicket.extensions.markup.html.form.select.Select;
import org.apache.wicket.extensions.markup.html.form.select.SelectOptions;
import org.apache.wicket.injection.Injector;
import org.apache.wicket.markup.html.WebMarkupContainer;
import org.apache.wicket.markup.html.form.Button;
import org.apache.wicket.markup.html.form.Form;
import org.apache.wicket.markup.repeater.RepeatingView;
import org.apache.wicket.model.IModel;
import org.apache.wicket.model.Model;
import org.apache.wicket.spring.injection.annot.SpringBean;
import org.joda.money.Money;
import org.wickedsource.budgeteer.service.DateRange;
import org.wickedsource.budgeteer.service.budget.BudgetBaseData;
import org.wickedsource.budgeteer.service.budget.BudgetService;
import org.wickedsource.budgeteer.service.person.PersonRate;
import org.wickedsource.budgeteer.service.person.PersonService;
import org.wickedsource.budgeteer.web.BudgeteerSession;
import org.wickedsource.budgeteer.web.components.daterange.DateRangeInputField;
import org.wickedsource.budgeteer.web.components.listMultipleChoiceWithGroups.OptionGroup;
import org.wickedsource.budgeteer.web.components.money.BudgetUnitMoneyModel;
import org.wickedsource.budgeteer.web.components.money.MoneyTextField;
import org.wickedsource.budgeteer.web.components.multiselect.MultiselectBehavior;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import static org.wicketstuff.lazymodel.LazyModel.from;
import static org.wicketstuff.lazymodel.LazyModel.model;

public abstract class PersonRateForm extends Form<PersonRateFormDto> {

    @SpringBean
    private BudgetService budgetService;

    MoneyTextField rateField;

    DateRangeInputField dateRangeField;

    PersonRateForm(PersonRateFormDto data) {
        super("addRateForm", new Model<>(data));
        Injector.get().inject(this);
        rateField = new MoneyTextField("rateField", new Model<>(getModelObject().getRate()));
        rateField.setRequired(true);
        add(rateField);
        dateRangeField = new DateRangeInputField("dateRangeField", new Model<>(getModelObject().getDateRange()), DateRangeInputField.DROP_LOCATION.UP);
        dateRangeField.setRequired(true);
        add(dateRangeField);
        List<OptionGroup<BudgetBaseData>> possibleBudgets = budgetService.getPossibleBudgetDataForPersonAndProject(BudgeteerSession.get().getProjectId(), data.getPersonId());
        addBudgetsDropdown(possibleBudgets);
        add(new Button("submitButton"));
    }

    @Override
    protected void onSubmit() {
        PersonRateFormDto addedPersonRate = getModelObject();
        for(BudgetBaseData budget : addedPersonRate.getChosenBudgets().getObject()) {
            List<PersonRate> overlappingRate = getOverlappingRates(dateRangeField.getModelObject(), budget);
            if (overlappingRate == null || overlappingRate.isEmpty()) {
                rateAdded(new PersonRate(rateField.getModelObject(), budget, dateRangeField.getModelObject()));
            } else {
                StringBuilder overlappingEntryNames = new StringBuilder();
                overlappingEntryNames.append(System.getProperty("line.separator"));
                for (int i = 0; i < overlappingRate.size(); i++) {
                    PersonRate p = overlappingRate.get(i);
                    overlappingEntryNames.append(p.getBudget().getName());
                    overlappingEntryNames.append(" ");
                    overlappingEntryNames.append(p.getDateRange().toString());
                    if (i < overlappingRate.size() - 1) {
                        overlappingEntryNames.append(",");
                        overlappingEntryNames.append(System.getProperty("line.separator"));
                    }
                }
                error(String.format(getString("personRateForm.overlappingRates"), overlappingEntryNames.toString()));
                return;
            }
        }
        addedPersonRate.getChosenBudgets().getObject().clear();
    }

    protected abstract void rateAdded(PersonRate rate);

    /**
     * Returns a List<PersonRate> where the startDate or the endDate is in the given dateRange (alternatively a empty List)
     * @param dateRange the dateRange to be checked
     * @return a List of PersonRates (if there are no PersonRates that end or start in the dateRange, a empty List will be returned)
     */
    protected abstract List<PersonRate> getOverlappingRates(DateRange dateRange, BudgetBaseData budget);

    /**
     * This methods adds a dropdown menu for the available budgets.
     * @param possibleBudgets A list of grouped possible budgets
     */
    private void addBudgetsDropdown(List<OptionGroup<BudgetBaseData>> possibleBudgets){
        Select<ArrayList<BudgetBaseData>> select = new Select<>("select", getModelObject().getChosenBudgets());
        HashMap<String, String> multiselectOptions = MultiselectBehavior.getRecommendedOptions();
        multiselectOptions.put("includeSelectAllOption","false");
        add(select.setRequired(true).add(new MultiselectBehavior(multiselectOptions)));
        RepeatingView rv = new RepeatingView("repeatingView");
        rv.setOutputMarkupId(true);
        rv.setOutputMarkupPlaceholderTag(true);
        select.add(rv);
        for(OptionGroup<BudgetBaseData> group : possibleBudgets){
            WebMarkupContainer overOptGroup = new WebMarkupContainer(rv.newChildId());
            rv.add(overOptGroup);
            WebMarkupContainer optGroup = new WebMarkupContainer("optGroup");
            overOptGroup.add(optGroup);
            optGroup.add(new AttributeModifier("label", new Model<>(group.getGroupNameResourceKey())));
            Model<ArrayList<BudgetBaseData>> a = new Model<>(new ArrayList<>(group.getOptions()));
            optGroup.add(
                    new SelectOptions<>("selectOptions", a, new IOptionRenderer<BudgetBaseData>() {
                        @Override
                        public String getDisplayValue(BudgetBaseData object) {
                            return object.getName();
                        }
                        @Override
                        public IModel<BudgetBaseData> getModel(BudgetBaseData value) {
                            return new Model<>(value);
                        }
                    })
            );
        }
    }
}
